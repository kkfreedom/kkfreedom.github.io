<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="起因 新装的arch没用几天，印象里除了例行的yay -Syu滚动更新以外， 没有做其他的设置。突然某一天，konsole中ping不通googl"><title>Archlinux DNS故障排查记</title><link rel=canonical href=https://kkfreedom.github.io/2021/05/archlinux-dns%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E8%AE%B0/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="Archlinux DNS故障排查记"><meta property="og:description" content="起因 新装的arch没用几天，印象里除了例行的yay -Syu滚动更新以外， 没有做其他的设置。突然某一天，konsole中ping不通googl"><meta property="og:url" content="https://kkfreedom.github.io/2021/05/archlinux-dns%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E8%AE%B0/"><meta property="og:site_name" content="可可积木小屋"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="网络"><meta property="article:published_time" content="2021-05-25T12:07:07+08:00"><meta property="article:modified_time" content="2021-05-25T12:07:07+08:00"><meta property="og:image" content="https://kkfreedom.github.io/2021/05/archlinux-dns%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E8%AE%B0/cover.jpg"><meta name=twitter:title content="Archlinux DNS故障排查记"><meta name=twitter:description content="起因 新装的arch没用几天，印象里除了例行的yay -Syu滚动更新以外， 没有做其他的设置。突然某一天，konsole中ping不通googl"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kkfreedom.github.io/2021/05/archlinux-dns%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E8%AE%B0/cover.jpg"><link rel="shortcut icon" href=/img/favicon.ico><style>:root{--article-font-family:"Noto Serif SC", var(--base-font-family)}</style><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header class=site-info><figure class=site-avatar><img src=/img/avatar_sun_hub2f995dd40e5756879d5cd1cf846e26e_9988_300x0_resize_q75_box.jpeg width=300 height=300 class=site-logo loading=lazy alt=Avatar></figure><h1 class=site-name><a href=/>可可积木小屋</a></h1><h2 class=site-description></h2></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>主页</span></a></li><li><a href=/page/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>关于</span></a></li><li><a href=/page/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>归档</span></a></li><li><a href=/page/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>搜索</span></a></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>暗色模式</span></li></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/2021/05/archlinux-dns%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E8%AE%B0/><img src=/2021/05/archlinux-dns%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E8%AE%B0/cover_hu84f9b07b51c1a6fa309a83e9713505d3_1281574_800x0_resize_q75_box.jpg srcset="/2021/05/archlinux-dns%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E8%AE%B0/cover_hu84f9b07b51c1a6fa309a83e9713505d3_1281574_800x0_resize_q75_box.jpg 800w, /2021/05/archlinux-dns%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E8%AE%B0/cover_hu84f9b07b51c1a6fa309a83e9713505d3_1281574_1600x0_resize_q75_box.jpg 1600w" width=800 height=450 loading=lazy alt="Featured image of post Archlinux DNS故障排查记"></a></div><div class=article-details><header class=article-category><a href=/categories/%E7%BC%96%E7%A8%8B/ style=background-color:#2a9d8f;color:#fff>编程</a></header><h2 class=article-title><a href=/2021/05/archlinux-dns%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E8%AE%B0/>Archlinux DNS故障排查记</a></h2><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>May 25, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 2 分钟</time></div></footer></div></header><section class=article-content><h1 id=起因>起因</h1><p>新装的arch没用几天，印象里除了例行的yay -Syu滚动更新以外， 没有做其他的设置。突然某一天，konsole中ping不通google和github了，甚至于baidu也不能ping，奇怪的是，浏览器可以正常访问。</p><h1 id=排查>排查</h1><p>于是开启了漫长的排查和搜索。首先想到的是DNS出问题了，因为konsole中ping IP是能ping通的。接着尝试了以下方法：</p><ul><li>手动设置8.8.8.8等DNS服务器到/etc/resolv.conf中。随后发现该文件每次都会被网络托管的NetworkManager覆盖回去。遂再一次修改之后，执行chattr +i /etc/resolv.conf，禁止被修改。-未果</li><li>添加rc.conf文件，手动添加网卡进去interface=eth0 -未果</li><li>在/etc/hosts中添加本地DNS映射 -方向错误，不能解决这次的问题
再尝试以上全部失败后，一次尝试安装一款DNS分析软件过程中，意外的发现连不到任何的镜像服务器。于是开始怀疑是cgproxy配置的全局代理导致的问题。systemctl stop cgproxy 之后终于ping通了baidu。</li></ul><h1 id=解决>解决</h1><p>虽然关掉cgproxy之后可以正常ping了，但是全局代理不能不要哇。再重复阅读Arch安装文档后发现一个关键点：</p><blockquote><p>(重要）如果启用了 udp 的透明代理（dns 也是 udp），则给 v2ray 二进制文件加上相应的特权：<code>sudo setcap "cap_net_admin, cap_net_bind_service=ep" /usr/bin/v2ray</code>
否则 udp 的透明代理可能会出问题。
如果每次更新了 v2ray 二进制文件，都需要重新执行此命令。</p></blockquote><p>重点就是每次更新v2ray二进制文件后都需要重新加特权，重启之后一起恢复正常。</p><h1 id=复盘>复盘</h1><ol><li>文档很重要。在后续查看文档之后，了解到v2ray在选中某些配置后（DNS拦截，udp透明代理）会将DNS托管给v2ray内置的DNS服务器。猜测是滚动更新连带更新了v2ray却没有赋权导致内部DNS服务异常。</li><li>遇到问题应该一开始就查看相应的文档，而不是google，网上其他人的解决方案没有详细的上下文，往往并不适用。</li><li>找准方向，一击破之。</li><li>及时快照保存当前稳定的系统。</li></ol></section><footer class=article-footer><section class=article-tags><a href=/tags/%E7%BD%91%E7%BB%9C/>网络</a></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>相关文章</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/2020/07/gradle%E5%AE%9E%E6%93%8D%E7%AC%94%E8%AE%B0/><div class=article-image><img src=/2020/07/gradle%E5%AE%9E%E6%93%8D%E7%AC%94%E8%AE%B0/cover.6ff7da60ccffbaf189ce164a0dfc0962_hu5c6d06279e6b27fb748baef0294dab76_607830_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy data-key data-hash="md5-b/faYMz/uvGJzhZKDfwJYg=="></div><div class=article-details><h2 class=article-title>Gradle实操笔记</h2></div></a></article><article class=has-image><a href=/2020/03/mockito/><div class=article-image><img src=/2020/03/mockito/cover.eba6a047935d4d655aa2d1f286d3108c_hu8ecab81d7be829095e928331adc62db1_251782_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy data-key data-hash="md5-66agR5NdTWVaotHyhtMQjA=="></div><div class=article-details><h2 class=article-title>Mockito</h2></div></a></article><article class=has-image><a href=/2020/03/java-%E5%8F%8D%E5%B0%84/><div class=article-image><img src=/2020/03/java-%E5%8F%8D%E5%B0%84/cover.9e993dfede3fa15af893c81f077973b8_hua2926729b63f55b4e0fa61b40de222a7_193704_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy data-key data-hash="md5-npk9/t4/oVr4k8gfB3lzuA=="></div><div class=article-details><h2 class=article-title>Java 反射</h2></div></a></article><article class=has-image><a href=/2019/09/tcp%E7%9A%84%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%96%AD%E5%BC%80/><div class=article-image><img src=/2019/09/tcp%E7%9A%84%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%96%AD%E5%BC%80/cover.ae63fb33ca468b30f9e186eb5ad29626_hu623720fb580a9a5e713acd5d8dd5e947_968335_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy data-key=TCP的三次握手和四次断开 data-hash="md5-rmP7M8pGizD54YbrWtKWJg=="></div><div class=article-details><h2 class=article-title>TCP的三次握手和四次断开</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2019 -
2022 可可积木小屋</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.5.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>